# =============================================================================
# dnsmasq-sqlite Beispiel-Konfiguration
# =============================================================================
#
# Diese Konfiguration zeigt alle verfügbaren Optionen für dnsmasq-sqlite
# mit Unterstützung für:
#   - SQLite-basierte DNS-Blockierung (2+ Milliarden Domains)
#   - DNS-Doctoring (IP-Rewrite)
#   - IPSet-basierte Forwarding-Regeln
#   - Performance-Optimierungen für Enterprise-Server
#
# Hardware-Target: HP DL20 G10+ (128 GB RAM, NVMe SSD, FreeBSD)
# Schema Version: 4.1
#
# =============================================================================

# -----------------------------------------------------------------------------
# GRUNDEINSTELLUNGEN
# -----------------------------------------------------------------------------

# Interface an dem dnsmasq lauscht
interface=eth0

# Port für DNS-Queries (Standard: 53)
port=53

# Anzahl gleichzeitiger DNS-Queries (Standard: 150)
# Für hohe Last (>10k q/s) erhöhen
dns-forward-max=1000

# User unter dem dnsmasq läuft (Sicherheit)
user=dnsmasq
group=dnsmasq

# PID-Datei
pid-file=/var/run/dnsmasq.pid

# -----------------------------------------------------------------------------
# CACHING
# -----------------------------------------------------------------------------

# DNS-Cache-Größe
# - 0 = Cache deaktiviert (nicht empfohlen!)
# - 10000 = Empfohlen für SQLite-Backend (Standard)
# - 50000 = Für sehr hohe Query-Raten
cache-size=10000

# Negative Caching (NXDOMAIN-Antworten cachen)
# Zeit in Sekunden
neg-ttl=3600

# Maximale TTL für gecachte Einträge
max-cache-ttl=3600

# Minimale TTL (verhindert zu kurze TTLs)
min-cache-ttl=60

# Cache auch bei /etc/hosts Änderungen beibehalten
no-hosts

# -----------------------------------------------------------------------------
# SQLITE-DATENBANK
# -----------------------------------------------------------------------------

# Pfad zur SQLite-Datenbank
# WICHTIG: Diese Datei muss existieren!
db-file=/var/db/dnsmasq/blocklist.db

# Alternative Pfade (kommentiere aus was du brauchst):
# db-file=/opt/dnsmasq/blocklist.db
# db-file=/home/user/dnsmasq/blocklist.db

# -----------------------------------------------------------------------------
# IPSET-KONFIGURATIONEN (Schema v4.1)
# -----------------------------------------------------------------------------

# IPSetTerminate: Direkte IPv4-Antworten für geblockte Domains
# Verwendet von: block_regex, block_exact
# Format: Komma-separierte IPv4-Adressen (OHNE Port!)
ipset-terminate-v4=0.0.0.0,127.0.0.1

# IPSetTerminate: Direkte IPv6-Antworten für geblockte Domains
# Verwendet von: block_regex, block_exact
# Format: Komma-separierte IPv6-Adressen (OHNE Port!)
ipset-terminate-v6=::,::1

# IPSetDNSBlock: DNS-Server für Blocking (gibt 0.0.0.0 zurück)
# Verwendet von: block_wildcard, fqdn_dns_block
# Format: Server mit Port-Notation
# Beispiele:
#   - 127.0.0.1#5353 (IPv4 mit Port 5353)
#   - [fd00::1]:5353 (IPv6 mit Port 5353)
ipset-dns-block=127.0.0.1#5353

# Optional: IPv6 DNS-Blocker
# ipset-dns-block=[fd00::1]:5353

# IPSetDNSAllow: Echte DNS-Server für Whitelisting
# Verwendet von: fqdn_dns_allow
# Format: Server mit optionalem Port
ipset-dns-allow=8.8.8.8,8.8.4.4

# Alternative DNS-Server (kommentiere aus was du brauchst):
# ipset-dns-allow=1.1.1.1,1.0.0.1                              # Cloudflare
# ipset-dns-allow=9.9.9.9,149.112.112.112                      # Quad9
# ipset-dns-allow=208.67.222.222,208.67.220.220                # OpenDNS
# ipset-dns-allow=8.8.8.8#53,[2001:4860:4860::8888]:53         # Google (IPv4+IPv6)

# -----------------------------------------------------------------------------
# DNS-DOCTORING (IP-REWRITE) - NEU in Schema v4.1
# -----------------------------------------------------------------------------

# DNS-Doctoring wird über die Datenbank gesteuert (Tabelle: dns_rewrite)
# Keine zusätzliche Konfiguration erforderlich!
#
# Beispiel-Einträge in der Datenbank:
#
#   INSERT INTO dns_rewrite (Domain, IPv4, IPv6) VALUES
#       ('internal.example.com', '10.0.0.50', 'fd00::50'),
#       ('api.local.net', '192.168.1.100', NULL);
#
# Lookup-Priorität: Step 2a (nach block_exact, vor block_wildcard)

# -----------------------------------------------------------------------------
# LOGGING & DEBUGGING
# -----------------------------------------------------------------------------

# Log-Queries aktivieren (zeigt alle DNS-Anfragen)
# ACHTUNG: Erzeugt viele Log-Einträge!
log-queries

# Log-Facility (wo werden Logs gespeichert?)
# - Standard: syslog
# - File: /var/log/dnsmasq.log
log-facility=/var/log/dnsmasq.log

# Async-Logging (Performance-Optimierung)
# Reduziert I/O-Blocking bei hohen Query-Raten
log-async=50

# Zusätzliche Debug-Infos (nur für Entwicklung!)
# log-debug

# -----------------------------------------------------------------------------
# PERFORMANCE-OPTIMIERUNGEN
# -----------------------------------------------------------------------------

# Bind-Interfaces (bessere Performance als listen-address)
bind-interfaces

# Kein Polling von /etc/resolv.conf (statische Konfiguration)
no-poll

# Kein Lesen von /etc/hosts
no-hosts

# Keine DHCP-Server-Funktionalität (nur DNS)
no-dhcp-interface=*

# Strikte Order (verhindert parallele Upstream-Queries)
# Deaktiviert für bessere Performance mit SQLite-Backend
# strict-order

# All-Servers (query alle Upstream-Server parallel)
# Aktiviert für niedrigere Latenz
all-servers

# -----------------------------------------------------------------------------
# SICHERHEIT
# -----------------------------------------------------------------------------

# Blocke private IP-Ranges in DNS-Antworten (DNS-Rebinding-Schutz)
# ACHTUNG: Deaktivieren bei DNS-Doctoring mit privaten IPs!
# stop-dns-rebind

# Erlaube private IPs in DNS-Antworten (für DNS-Doctoring erforderlich!)
rebind-localhost-ok
rebind-domain-ok=/local/
rebind-domain-ok=/internal/

# Bogus-Priv (verhindert Reverse-Lookups für private IPs)
# Deaktiviert bei Verwendung von privatem DNS
# bogus-priv

# DNSSEC-Validierung
# Achtung: Kann Latenz erhöhen
# dnssec
# trust-anchor=.,19036,8,2,49AAC11D7B6F6446702E54A1607371607A1A41855200FD2CE1CDDE32F24E8FB5

# Domain-Whitelist (erlaubt nur diese Domains)
# Nützlich für restriktive Umgebungen
# domain-needed
# local=/local/

# -----------------------------------------------------------------------------
# IPv6-EINSTELLUNGEN
# -----------------------------------------------------------------------------

# IPv6 aktivieren
# Standard: aktiviert wenn System IPv6 unterstützt

# Nur IPv4 verwenden (IPv6 komplett deaktivieren)
# no-ipv6

# Filter-AAAA: Blocke IPv6-Antworten
# Nützlich wenn IPv6 Probleme macht
# filter-AAAA

# -----------------------------------------------------------------------------
# ERWEITERTE OPTIONEN
# -----------------------------------------------------------------------------

# Expand-Hosts: Füge Domain zu einfachen Namen hinzu
# expand-hosts
# domain=example.com

# Lokale Domains (werden nicht weitergeleitet)
# local=/local/
# local=/internal/

# Address-Override: Bestimmte Domains auf IP umleiten
# Achtung: Besser über dns_rewrite Tabelle in SQLite!
# address=/ads.example.com/0.0.0.0

# Server-Override: Bestimmte Domains an spezifischen DNS-Server
# server=/example.com/10.0.0.1
# server=/internal.local/192.168.1.1

# EDNS-Packet-Größe (Standard: 4096)
edns-packet-max=4096

# Query-Rate-Limiting (DDoS-Schutz)
# Format: <queries>/<seconds>
# rate-limit=1000/60

# -----------------------------------------------------------------------------
# BEISPIEL-KONFIGURATIONEN FÜR VERSCHIEDENE SZENARIEN
# -----------------------------------------------------------------------------

# --- Szenario 1: Maximale Performance (128 GB RAM Server) ---
#
# cache-size=50000
# dns-forward-max=1000
# log-async=100
# all-servers
# bind-interfaces
# no-poll
# no-hosts

# --- Szenario 2: Strenge Sicherheit ---
#
# stop-dns-rebind
# bogus-priv
# dnssec
# domain-needed
# cache-size=10000

# --- Szenario 3: NAT/DNS-Doctoring ---
#
# rebind-localhost-ok
# rebind-domain-ok=/local/
# rebind-domain-ok=/internal/
# ipset-dns-allow=8.8.8.8,8.8.4.4
# db-file=/var/db/dnsmasq/blocklist.db
#
# In DB:
#   INSERT INTO dns_rewrite VALUES
#       ('internal.example.com', '10.0.0.50', 'fd00::50');

# --- Szenario 4: Split-Horizon DNS ---
#
# interface=eth0,eth1
# local=/internal.local/
# server=/internal.local/192.168.1.1
# server=/external.com/8.8.8.8
#
# In DB:
#   INSERT INTO dns_rewrite VALUES
#       ('app.internal.local', '192.168.10.50', NULL);

# =============================================================================
# TABELLEN-ÜBERSICHT (SQLite-Datenbank)
# =============================================================================
#
# Schema v4.1 Lookup-Order:
#
# 1. block_regex (Pattern TEXT)
#    → PCRE2 Regex-Matching
#    → Rückgabe: IPSetTerminate (ipset-terminate-v4/v6)
#    → Beispiel: ^ad[sz]?[0-9]*\..*$ matched ads.google.com
#
# 2. block_exact (Domain TEXT)
#    → Exakte Domain-Blockierung (keine Subdomains!)
#    → Rückgabe: IPSetTerminate (ipset-terminate-v4/v6)
#    → Beispiel: ads.example.com geblockt (NICHT www.ads.example.com)
#
# 2a. dns_rewrite (Domain TEXT, IPv4 TEXT, IPv6 TEXT) ← NEU!
#     → DNS-Doctoring: IP-Rewrite
#     → Rückgabe: Benutzerdefinierte IPv4/IPv6
#     → Beispiel: internal.example.com → 10.0.0.50 / fd00::50
#
# 3. block_wildcard (Domain TEXT)
#    → Wildcard-Blocking (inkl. Subdomains)
#    → Rückgabe: IPSetDNSBlock (ipset-dns-block)
#    → Beispiel: example.com matched auch www.example.com
#
# 4. fqdn_dns_allow (Domain TEXT)
#    → Whitelist: Forward zu echten DNS-Servern
#    → Rückgabe: IPSetDNSAllow (ipset-dns-allow)
#    → Beispiel: trusted.xyz → 8.8.8.8
#
# 5. fqdn_dns_block (Domain TEXT)
#    → Blacklist: Forward zu Blocker-DNS
#    → Rückgabe: IPSetDNSBlock (ipset-dns-block)
#    → Beispiel: *.xyz → 127.0.0.1#5353
#
# Kein Match → Normale DNS-Auflösung (Upstream-Server)
#
# =============================================================================

# =============================================================================
# WARTUNG & MONITORING
# =============================================================================

# Logs prüfen:
#   tail -f /var/log/dnsmasq.log
#
# Statistiken:
#   killall -USR1 dnsmasq    # Dump cache statistics to log
#
# Reload (ohne Neustart):
#   killall -HUP dnsmasq     # Reload config + DB
#   systemctl reload dnsmasq
#
# Performance-Test:
#   dig @127.0.0.1 example.com
#   drill @127.0.0.1 example.com
#
# Cache-Statistiken:
#   sqlite3 /var/db/dnsmasq/blocklist.db "SELECT COUNT(*) FROM dns_rewrite;"
#
# =============================================================================
# ENDE DER KONFIGURATION
# =============================================================================
